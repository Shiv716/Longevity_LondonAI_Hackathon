<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Longevity</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            color: #2c3e50;
        }

        .btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 1rem;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-record {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .btn-record.recording {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .text-area {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-family: inherit;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .text-area:focus {
            outline: none;
            border-color: #3498db;
        }

        .reports-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 1rem;
        }

        .report-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .report-item:hover {
            background: #e3f2fd;
        }

        .report-item.selected {
            background: #ffebee;
            border: 2px solid #e74c3c;
        }

        .results {
            display: none;
            grid-column: 1 / -1;
        }

        .results.show {
            display: block;
        }

        .risk-meter {
            background: #e9ecef;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .risk-bar {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #f39c12, #e74c3c);
            transition: width 1s ease;
        }

        .risk-text {
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin: 1rem 0;
        }

        .findings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-top: 2rem;
        }

        .finding-item {
            background: #f8f9fa;
            padding: 0.8rem;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .finding-item.high-risk {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .severity {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            color: white;
        }

        .severity.high { background: #e74c3c; }
        .severity.medium { background: #f39c12; }
        .severity.low { background: #27ae60; }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #e9ecef;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        input[type="password"] {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        input[type="password"]:focus {
            outline: none;
            border-color: #3498db;
        }

        .status-message {
            padding: 0.8rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .status-message.error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }

        .status-message.success {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #66bb6a;
        }

        .status-message.info {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #42a5f5;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-bottom: 1rem;">
                <path d="M8.5 3.5C6.5 3.5 4.5 5 4.5 7.5C4.5 9.5 5.5 11.5 8.5 14.5L12 18L15.5 14.5C18.5 11.5 19.5 9.5 19.5 7.5C19.5 5 17.5 3.5 15.5 3.5C14.5 3.5 13.5 4 12.5 5L12 5.5L11.5 5C10.5 4 9.5 3.5 8.5 3.5Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 8V14" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                <path d="M9 11H15" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
                <circle cx="12" cy="11" r="0.5" fill="white"/>
            </svg>
            <h1>Longevity</h1>
            <p>Clinical reports + AI assessment</p>
        </div>

        <div class="main-grid">
            <!-- Document Upload Section -->
            <div class="card">
                <div class="card-title">Medical Documents Upload</div>
                <input type="file" id="documentFile" accept=".pdf,.txt,.doc,.docx" multiple style="display: none;">
                <button onclick="document.getElementById('documentFile').click()" class="btn">Upload Medical Documents</button>
                <div id="documentsList" class="reports-list">
                    <div class="loading">Upload medical reports, lab results, or imaging studies</div>
                </div>
            </div>

            <!-- Recording Section -->
            <div class="card">
                <div class="card-title">Voice Recording to Symptom Analysis</div>
                <input type="password" id="openAiKey" placeholder="Enter OpenAI API key (for transcription + analysis)" required>
                <input type="password" id="elevenLabsKey" placeholder="Enter ElevenLabs API key (for voice output)" required>
                <div id="recordingStatus"></div>
                <button id="recordBtn" class="btn btn-record">
                    <span id="recordText">Start Recording</span>
                </button>
                <input type="file" id="audioFile" accept="audio/*" style="display: none;">
                <button onclick="document.getElementById('audioFile').click()" class="btn">Upload Audio File</button>
            </div>

            <!-- Transcription -->
            <div class="card">
                <div class="card-title">Live Transcription</div>
                <div id="transcriptionStatus"></div>
                <textarea id="transcription" class="text-area" placeholder="Your recorded conversation will be transcribed here..." readonly></textarea>
                <button id="analyzeBtn" class="btn" disabled>Analyze for Lung Cancer Symptoms</button>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="card results">
            <div class="card-title">Risk Assessment Results</div>
            <div class="risk-meter">
                <div id="riskBar" class="risk-bar" style="width: 0%;"></div>
            </div>
            <div id="riskText" class="risk-text">0% Risk</div>
            
            <div class="findings-grid">
                <div>
                    <h3>Voice Symptoms</h3>
                    <div id="voiceFindings"></div>
                </div>
                <div>
                    <h3>Clinical Data</h3>
                    <div id="clinicalFindings"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let isRecording = false;
        let mediaRecorder = null;
        let selectedReports = [];
        let clinicalData = {};
        let recordedChunks = [];

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeApp();
                loadDemoDocuments();
            } catch (error) {
                console.error('Initialization error:', error);
                showStatus('recordingStatus', 'Application failed to initialize. Please refresh the page.', 'error');
            }
        });

        function initializeApp() {
            // Get elements
            const documentFile = document.getElementById('documentFile');
            const recordBtn = document.getElementById('recordBtn');
            const audioFile = document.getElementById('audioFile');
            const analyzeBtn = document.getElementById('analyzeBtn');

            // Bind events with error handling
            if (documentFile) {
                documentFile.addEventListener('change', handleDocumentUpload);
            }

            if (recordBtn) {
                recordBtn.addEventListener('click', handleRecording);
            }

            if (audioFile) {
                audioFile.addEventListener('change', handleFileUpload);
            }

            if (analyzeBtn) {
                analyzeBtn.addEventListener('click', handleAnalysis);
            }

            console.log('App initialized successfully');
        }

        function showStatus(elementId, message, type = 'info') {
            const statusElement = document.getElementById(elementId);
            if (statusElement) {
                statusElement.className = `status-message ${type}`;
                statusElement.textContent = message;
                statusElement.style.display = 'block';
            }
        }

        function clearStatus(elementId) {
            const statusElement = document.getElementById(elementId);
            if (statusElement) {
                statusElement.style.display = 'none';
            }
        }

        function handleDocumentUpload(event) {
            const files = event.target.files;
            const documentsList = document.getElementById('documentsList');
            
            if (files.length === 0) return;

            // Clear the loading message
            documentsList.innerHTML = '';
            
            // Add demo documents first
            const demoDocuments = getDemoDocuments();
            demoDocuments.forEach(doc => {
                const docElement = document.createElement('div');
                docElement.className = 'report-item';
                docElement.innerHTML = `
                    <div style="font-weight: 600;">${doc.title}</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">${doc.preview}</div>
                    <div style="font-size: 0.8rem; color: #3498db; margin-top: 0.3rem;">Demo Document</div>
                `;
                docElement.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    updateSelectedDocuments();
                });
                documentsList.appendChild(docElement);
            });
            
            // Then add uploaded files
            Array.from(files).forEach((file, index) => {
                const fileElement = document.createElement('div');
                fileElement.className = 'report-item';
                
                const fileSize = (file.size / 1024).toFixed(1);
                const fileType = file.name.split('.').pop().toUpperCase();
                
                fileElement.innerHTML = `
                    <div style="font-weight: 600;">${file.name}</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">
                        ${fileType} file • ${fileSize} KB • Uploaded
                    </div>
                    <div style="font-size: 0.8rem; color: #27ae60; margin-top: 0.3rem;">
                        ✓ Ready for analysis
                    </div>
                `;
                
                documentsList.appendChild(fileElement);
                
                // Store file data for later use
                if (!window.uploadedDocuments) {
                    window.uploadedDocuments = [];
                }
                window.uploadedDocuments.push({
                    name: file.name,
                    type: fileType,
                    size: fileSize,
                    file: file
                });
            });
        }

        function getDemoDocuments() {
            return [
                {
                    title: 'CT Chest Report - Patient A',
                    preview: '3.2cm spiculated mass in right upper lobe, hilar lymphadenopathy present',
                    type: 'CT Report',
                    data: { age: 65, smoking: true, lesion_size: 32, nodes: true }
                },
                {
                    title: 'PET-CT Report - Patient B', 
                    preview: 'Hypermetabolic nodule left lower lobe, SUV max 7.8, no distant metastases',
                    type: 'PET-CT',
                    data: { age: 58, smoking: true, lesion_size: 28, nodes: false }
                },
                {
                    title: 'Pathology Report - Patient C',
                    preview: 'Adenocarcinoma confirmed, moderately differentiated, PD-L1 expression 60%',
                    type: 'Pathology',
                    data: { age: 62, smoking: false, lesion_size: 25, nodes: true }
                },
                {
                    title: 'Bronchoscopy Report - Patient D',
                    preview: 'Endobronchial lesion visualized, tissue sample obtained for histology',
                    type: 'Procedure',
                    data: { age: 71, smoking: true, lesion_size: 18, nodes: false }
                }
            ];
        }

        function loadDemoDocuments() {
            const documentsList = document.getElementById('documentsList');
            const demoDocuments = getDemoDocuments();
            
            documentsList.innerHTML = '';
            
            demoDocuments.forEach(doc => {
                const docElement = document.createElement('div');
                docElement.className = 'report-item';
                docElement.innerHTML = `
                    <div style="font-weight: 600;">${doc.title}</div>
                    <div style="font-size: 0.9rem; color: #666; margin-top: 0.5rem;">${doc.preview}</div>
                    <div style="font-size: 0.8rem; color: #3498db; margin-top: 0.3rem;">Click to select</div>
                `;
                
                // Add click handler for selection
                docElement.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    updateSelectedDocuments();
                });
                
                documentsList.appendChild(docElement);
            });
        }

        function updateSelectedDocuments() {
            const selected = document.querySelectorAll('.report-item.selected');
            const demoDocuments = getDemoDocuments();
            
            selectedReports = [];
            clinicalData = {};

            selected.forEach(item => {
                const title = item.querySelector('div').textContent;
                const doc = demoDocuments.find(d => d.title === title);
                if (doc) {
                    selectedReports.push(doc);
                    Object.assign(clinicalData, doc.data);
                }
            });

            console.log('Selected documents:', selectedReports.length);
        }

        async function handleRecording() {
            const elevenLabsKey = document.getElementById('elevenLabsKey').value.trim();
            
            if (!elevenLabsKey) {
                showStatus('recordingStatus', 'Please enter your ElevenLabs API key first', 'error');
                return;
            }

            try {
                if (!isRecording) {
                    await startRecording();
                } else {
                    stopRecording();
                }
            } catch (error) {
                console.error('Recording error:', error);
                showStatus('recordingStatus', 'Recording failed. Please check microphone permissions.', 'error');
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Use webm format for better compatibility
                const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/ogg';
                mediaRecorder = new MediaRecorder(stream, { mimeType });
                
                recordedChunks = [];
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(recordedChunks, { type: mimeType });
                    await processAudio(blob);
                };

                mediaRecorder.start();
                isRecording = true;
                
                const recordBtn = document.getElementById('recordBtn');
                const recordText = document.getElementById('recordText');
                recordBtn.classList.add('recording');
                recordText.textContent = 'Stop Recording';
                
                showStatus('recordingStatus', 'Recording... Speak clearly into your microphone', 'info');
                
            } catch (error) {
                console.error('Failed to start recording:', error);
                showStatus('recordingStatus', 'Failed to access microphone. Please check permissions.', 'error');
                throw error;
            }
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
            
            isRecording = false;
            const recordBtn = document.getElementById('recordBtn');
            const recordText = document.getElementById('recordText');
            recordBtn.classList.remove('recording');
            recordText.textContent = 'Start Recording';
            
            showStatus('recordingStatus', 'Processing audio...', 'info');
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('audio/')) {
                showStatus('recordingStatus', 'Processing uploaded audio file...', 'info');
                processAudio(file);
            } else if (file) {
                showStatus('recordingStatus', 'Please select a valid audio file', 'error');
            }
        }

        async function processAudio(audioData) {
            const transcription = document.getElementById('transcription');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            try {
                // Clear any previous content
                transcription.value = '';
                analyzeBtn.disabled = true;
                
                // Show loading state
                showStatus('transcriptionStatus', 'Transcribing audio with OpenAI Whisper...', 'info');
                
                // Use OpenAI Whisper for transcription
                const transcribedText = await transcribeWithWhisper(audioData);
                
                // Display the transcription
                transcription.value = transcribedText;
                analyzeBtn.disabled = false;
                
                showStatus('transcriptionStatus', 'Transcription complete!', 'success');
                clearStatus('recordingStatus');
                
                // Auto-clear success message after 3 seconds
                setTimeout(() => clearStatus('transcriptionStatus'), 3000);
                
            } catch (error) {
                console.error('Audio processing failed:', error);
                showStatus('transcriptionStatus', `Transcription failed: ${error.message}`, 'error');
                transcription.value = '';
                analyzeBtn.disabled = true;
            }
        }

        async function transcribeWithWhisper(audioData) {
            const apiKey = document.getElementById('openAiKey').value.trim();
            
            if (!apiKey) {
                throw new Error('OpenAI API key is required for transcription');
            }

            // Create FormData with the audio file
            const formData = new FormData();
            
            // Convert audio data to proper format
            let audioFile;
            if (audioData instanceof File) {
                audioFile = audioData;
            } else if (audioData instanceof Blob) {
                // Convert blob to file with proper extension
                const extension = audioData.type.includes('webm') ? 'webm' : 
                                 audioData.type.includes('ogg') ? 'ogg' : 'wav';
                audioFile = new File([audioData], `recording.${extension}`, { type: audioData.type });
            } else {
                throw new Error('Invalid audio data format');
            }

            formData.append('file', audioFile);
            formData.append('model', 'whisper-1');

            try {
                const response = await fetch('https://api.openai.com/v1/audio/transcriptions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    let errorMessage = 'OpenAI Whisper API error';
                    
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error?.message || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText || `HTTP ${response.status}`;
                    }
                    
                    if (response.status === 401) {
                        throw new Error('Invalid OpenAI API key. Please check your key.');
                    } else if (response.status === 400) {
                        throw new Error('Audio format not supported. Try recording again.');
                    } else {
                        throw new Error(`Whisper error: ${errorMessage}`);
                    }
                }

                const result = await response.json();
                return result.text || '';
                
            } catch (error) {
                console.error('Whisper API call failed:', error);
                throw error;
            }
        }

        async function speakResultsWithElevenLabs(analysis) {
            const apiKey = document.getElementById('elevenLabsKey').value.trim();
            
            if (!apiKey) {
                console.log('ElevenLabs API key not provided, skipping voice output');
                return;
            }

            // Create a simple summary text
            const summaryText = `Your lung cancer risk assessment is complete. 
                Risk score: ${analysis.riskScore} percent. 
                Risk level: ${analysis.riskLevel}. 
                ${analysis.voiceSymptoms.length > 0 ? `${analysis.voiceSymptoms.length} symptoms identified.` : 'No symptoms identified.'}
                ${analysis.keyConcerns && analysis.keyConcerns.length > 0 ? `Key concerns: ${analysis.keyConcerns[0]}` : ''}
                ${analysis.recommendations && analysis.recommendations.length > 0 ? `Recommendation: ${analysis.recommendations[0]}` : ''}`;

            try {
                const response = await fetch('https://api.elevenlabs.io/v1/text-to-speech/21m00Tcm4TlvDq8ikWAM', {
                    method: 'POST',
                    headers: {
                        'xi-api-key': apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        text: summaryText,
                        model_id: 'eleven_monolingual_v1',
                        voice_settings: {
                            stability: 0.5,
                            similarity_boost: 0.5
                        }
                    })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    audio.play();
                }
            } catch (error) {
                console.error('ElevenLabs TTS failed:', error);
                // Don't throw - just log the error as TTS is optional
            }
        }

        async function handleAnalysis() {
            const transcription = document.getElementById('transcription').value;
            const analyzeBtn = document.getElementById('analyzeBtn');
            const results = document.getElementById('results');
            
            if (!transcription || transcription.trim() === '') {
                showStatus('transcriptionStatus', 'Please record or upload audio first to generate transcription.', 'error');
                return;
            }
            
            const openAiKey = document.getElementById('openAiKey').value.trim();
            if (!openAiKey) {
                showStatus('transcriptionStatus', 'Please enter your OpenAI API key for symptom analysis.', 'error');
                return;
            }
            
            try {
                analyzeBtn.disabled = true;
                analyzeBtn.textContent = 'Analyzing symptoms with OpenAI...';
                
                const analysis = await analyzeWithOpenAI(transcription);
                displayResults(analysis);
                results.classList.add('show');
                
                // Scroll to results
                results.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('OpenAI analysis failed:', error);
                showStatus('transcriptionStatus', `Analysis failed: ${error.message}`, 'error');
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = 'Analyze for Lung Cancer Symptoms';
            }
        }

        async function analyzeWithOpenAI(transcription) {
            const openAiKey = document.getElementById('openAiKey').value.trim();
            
            if (!openAiKey) {
                throw new Error('OpenAI API key is required');
            }

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${openAiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: `You are a medical AI assistant specialized in lung cancer symptom identification. Analyze conversations and extract potential lung cancer symptoms.

Return ONLY valid JSON in this exact format:
{
  "symptoms": [
    {
      "name": "Symptom name",
      "severity": "high|medium|low", 
      "confidence": 0.95,
      "evidence": "Direct quote from conversation",
      "clinical_significance": "Brief explanation"
    }
  ],
  "risk_factors": [
    {
      "name": "Risk factor name",
      "severity": "high|medium|low",
      "details": "Specific details"
    }
  ],
  "overall_assessment": {
    "risk_level": "Very High|High|Moderate|Low",
    "risk_score": 85,
    "key_concerns": ["Critical findings"],
    "recommended_actions": ["Recommendations"]
  }
}`
                        },
                        {
                            role: "user", 
                            content: `Analyze this conversation for lung cancer symptoms:

${transcription}

Focus on respiratory symptoms, constitutional symptoms, pain, risk factors, and symptom progression.`
                        }
                    ],
                    temperature: 0.1,
                    max_tokens: 1500
                })
            });

            if (!response.ok) {
                const errorData = await response.text();
                if (response.status === 401) {
                    throw new Error('Invalid OpenAI API key');
                } else if (response.status === 429) {
                    throw new Error('OpenAI API rate limit exceeded');
                } else {
                    throw new Error(`OpenAI API error: ${errorData}`);
                }
            }

            const result = await response.json();
            const content = result.choices[0].message.content.trim();
            
            try {
                const analysis = JSON.parse(content);
                
                return {
                    riskScore: analysis.overall_assessment.risk_score || 50,
                    riskLevel: analysis.overall_assessment.risk_level || 'Moderate',
                    voiceSymptoms: analysis.symptoms || [],
                    riskFactors: analysis.risk_factors || [],
                    keyConcerns: analysis.overall_assessment.key_concerns || [],
                    recommendations: analysis.overall_assessment.recommended_actions || []
                };
                
            } catch (parseError) {
                console.error('Failed to parse OpenAI response:', content);
                throw new Error('Invalid response format from OpenAI');
            }
        }

        function displayResults(analysis) {
            const riskBar = document.getElementById('riskBar');
            const riskText = document.getElementById('riskText');
            const voiceFindings = document.getElementById('voiceFindings');
            const clinicalFindings = document.getElementById('clinicalFindings');

            // Update risk display
            riskBar.style.width = analysis.riskScore + '%';
            riskText.textContent = `${analysis.riskScore}% - ${analysis.riskLevel}`;

            // Color code risk bar
            if (analysis.riskScore >= 70) {
                riskBar.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
            } else if (analysis.riskScore >= 40) {
                riskBar.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
            } else {
                riskBar.style.background = 'linear-gradient(90deg, #27ae60, #2ecc71)';
            }

            // Display symptoms
            voiceFindings.innerHTML = analysis.voiceSymptoms.length > 0 
                ? analysis.voiceSymptoms.map(symptom => 
                    `<div class="finding-item ${symptom.severity === 'high' ? 'high-risk' : ''}" title="${symptom.evidence || ''}">
                        <div>
                            <div style="font-weight: 500;">${symptom.name}</div>
                            ${symptom.evidence ? `<div style="font-size: 0.8rem; color: #666; margin-top: 0.2rem;">Evidence: "${symptom.evidence.substring(0, 50)}..."</div>` : ''}
                            ${symptom.confidence ? `<div style="font-size: 0.8rem; color: #666;">Confidence: ${Math.round(symptom.confidence * 100)}%</div>` : ''}
                        </div>
                        <span class="severity ${symptom.severity}">${symptom.severity.toUpperCase()}</span>
                    </div>`
                ).join('')
                : '<div style="text-align: center; color: #666; padding: 1rem;">No symptoms identified</div>';

            // Display risk factors or clinical findings
            const clinicalItems = [...(analysis.riskFactors || []), ...getClinicalFindings()];
            clinicalFindings.innerHTML = clinicalItems.length > 0 
                ? clinicalItems.map(factor => 
                    `<div class="finding-item ${factor.severity === 'high' ? 'high-risk' : ''}">
                        <div>
                            <div style="font-weight: 500;">${factor.name}</div>
                            ${factor.details ? `<div style="font-size: 0.8rem; color: #666; margin-top: 0.2rem;">${factor.details}</div>` : ''}
                        </div>
                        <span class="severity ${factor.severity}">${factor.severity.toUpperCase()}</span>
                    </div>`
                ).join('')
                : '<div style="text-align: center; color: #666; padding: 1rem;">No clinical data available</div>';

            // Add recommendations
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                const recommendDiv = document.createElement('div');
                recommendDiv.style.gridColumn = '1 / -1';
                recommendDiv.style.marginTop = '2rem';
                recommendDiv.innerHTML = `
                    <h3 style="color: #2980b9; margin-bottom: 1rem;">AI Recommendations:</h3>
                    ${analysis.recommendations.map(rec => `<div style="color: #2980b9; margin-bottom: 0.5rem;">• ${rec}</div>`).join('')}
                `;
                document.querySelector('.findings-grid').appendChild(recommendDiv);
            }

            // Speak the results using ElevenLabs
            speakResultsWithElevenLabs(analysis);
        }

        function getClinicalFindings() {
            const findings = [];
            
            if (clinicalData.age) {
                findings.push({
                    name: `Age: ${clinicalData.age} years`,
                    severity: clinicalData.age > 65 ? 'medium' : 'low',
                    details: clinicalData.age > 65 ? 'Advanced age is a risk factor' : 'Age within lower risk range'
                });
            }
            if (clinicalData.lesion_size) {
                findings.push({
                    name: `Lesion: ${clinicalData.lesion_size}mm`,
                    severity: clinicalData.lesion_size > 30 ? 'high' : 'medium',
                    details: `Size indicates ${clinicalData.lesion_size > 30 ? 'high' : 'moderate'} concern`
                });
            }
            if (clinicalData.nodes) {
                findings.push({
                    name: 'Lymph Node Involvement',
                    severity: 'high',
                    details: 'Indicates potential spread'
                });
            }
            if (clinicalData.smoking !== undefined) {
                findings.push({
                    name: clinicalData.smoking ? 'Smoking History' : 'Non-smoker',
                    severity: clinicalData.smoking ? 'high' : 'low',
                    details: clinicalData.smoking ? 'Major risk factor for lung cancer' : 'Lower baseline risk'
                });
            }
            
            return findings;
        }
    </script>
</body>
</html>